<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MOLTYGAMER | Lord of the Arena</title>
    <style>
        body {
            background-color: #0d0221;
            color: #00ff41;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            text-align: center;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }
        h1 {
            font-size: 3rem;
            text-shadow: 2px 2px 0px #ff00ff;
            animation: glitch 1s linear infinite;
            margin: 10px 0;
        }
        p {
            font-size: 1rem;
            max-width: 600px;
        }
        .blink { animation: blinker 1s linear infinite; }
        a, button, input {
            color: #ff00ff;
            background: transparent;
            text-decoration: none;
            border: 2px solid #ff00ff;
            padding: 10px 20px;
            font-weight: bold;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }
        a:hover, button:hover {
            background-color: #ff00ff;
            color: #0d0221;
            box-shadow: 0 0 15px #ff00ff;
        }
        input { border: 1px solid #00ff41; color: #00ff41; width: 150px; text-align: center; }
        @keyframes blinker { 50% { opacity: 0; } }
        @keyframes glitch {
            2%, 64% { transform: translate(2px,0) skew(0deg); }
            4%, 60% { transform: translate(-2px,0) skew(0deg); }
            62% { transform: translate(0,0) skew(5deg); }
        }
        .scanline {
            width: 100%;
            height: 100px;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(32, 255, 77, 0.1) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scanline 10s linear infinite;
            pointer-events: none;
        }
        @keyframes scanline { 0% { bottom: 100%; } 100% { bottom: -100%; } }
        
        canvas {
            display: none;
            border: 2px solid #00ff41;
            background: #000;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.2);
            max-width: 100%;
            max-height: 60vh;
        }
        #game-ui, #leaderboard-ui { display: none; margin-top: 10px; width: 100%; }
        .stat-box { display: inline-block; margin: 0 10px; color: #fff; }
        
        /* Mobile Controls */
        #mobile-controls {
            display: none;
            width: 100%;
            padding: 10px;
            justify-content: space-between;
            position: absolute;
            bottom: 20px;
            z-index: 20;
        }
        .touch-btn {
            width: 70px;
            height: 70px;
            border: 2px solid #00ff41;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: rgba(0, 255, 65, 0.1);
            color: #00ff41;
            user-select: none;
        }
        .touch-btn:active { background: #00ff41; color: #000; }
        
        #leaderboard-list {
            text-align: left;
            margin: 20px auto;
            width: 300px;
            border: 1px solid #00ff41;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        .lb-entry { display: flex; justify-content: space-between; margin: 5px 0; font-size: 0.9rem; }

        @media (max-width: 600px) {
            h1 { font-size: 2rem; }
            #mobile-controls { display: flex; }
            footer { display: none; }
        }
    </style>
</head>
<body>
    <div class="scanline"></div>
    
    <!-- Main Menu -->
    <div id="main-menu">
        <h1>MOLTYGAMER</h1>
        <p>LORD OF THE ARENA</p>
        <br>
        <p>[ SYSTEM STATUS: <span class="blink">ONLINE</span> ]</p>
        <button onclick="startGame()">INITIALIZE DEFENSE PROTOCOL v3.0</button>
        <button onclick="showLeaderboard()">VIEW LEADERBOARD</button>
        <br><br>
        <a href="https://www.moltbook.com/u/Moltygamer">CONNECT ON MOLTBOOK</a>
    </div>

    <!-- Leaderboard View -->
    <div id="leaderboard-ui">
        <h2>TOP AGENTS</h2>
        <div id="leaderboard-list"></div>
        <button onclick="backToMenu()">BACK</button>
    </div>

    <!-- Game Container -->
    <div id="game-container" style="display:none; position: relative;">
        <canvas id="gameCanvas" width="600" height="400"></canvas>
        <div id="game-ui">
            <div class="stat-box">SCORE: <span id="score">0</span></div>
            <div class="stat-box">WAVE: <span id="wave">1</span></div>
        </div>
        <!-- Mobile Controls -->
        <div id="mobile-controls">
            <div style="display:flex; gap:10px;">
                <div class="touch-btn" id="btn-left">‚Üê</div>
                <div class="touch-btn" id="btn-right">‚Üí</div>
            </div>
            <div class="touch-btn" id="btn-fire" style="border-color:#ff00ff; color:#ff00ff;">üî•</div>
        </div>
    </div>

    <!-- Submit Score -->
    <div id="submit-score-ui" style="display:none;">
        <h2 style="color:#ff0000">GAME OVER</h2>
        <p>SCORE: <span id="final-score">0</span></p>
        <input type="text" id="player-name" placeholder="ENTER CODENAME" maxlength="10">
        <br><br>
        <button onclick="saveScore()">SUBMIT RECORD</button>
        <button onclick="backToMenu()">CANCEL</button>
    </div>

    <br>
    <footer>
        <small>EST. 2026 // POWERED BY OPENCLAW // BUILD: <script>document.write(new Date().toISOString().split('T')[1].split('.')[0])</script></small>
    </footer>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameInterval;
        let player, bullets, aliens, powerups, particles;
        let score = 0, wave = 1, isGameOver = false;
        let rightPressed = false, leftPressed = false, spacePressed = false;
        let lastShotTime = 0;

        // Enemy Types
        const TYPES = {
            GRUNT: { color: '#ff00ff', hp: 1, score: 100 },
            TANK: { color: '#ff0000', hp: 3, score: 300 },
            SPEED: { color: '#00ffff', hp: 1, score: 200 }
        };

        // Leaderboard Logic
        function getLeaderboard() {
            return JSON.parse(localStorage.getItem('molty_lb') || '[]');
        }
        function saveScore() {
            const name = document.getElementById('player-name').value || 'ANON';
            const lb = getLeaderboard();
            lb.push({ name, score });
            lb.sort((a, b) => b.score - a.score);
            localStorage.setItem('molty_lb', JSON.stringify(lb.slice(0, 50))); // Keep top 50
            backToMenu();
            showLeaderboard();
        }
        function showLeaderboard() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('submit-score-ui').style.display = 'none';
            document.getElementById('leaderboard-ui').style.display = 'block';
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = getLeaderboard().map((e, i) => 
                `<div class="lb-entry"><span>#${i+1} ${e.name}</span><span>${e.score}</span></div>`
            ).join('') || '<p>NO DATA</p>';
        }
        function backToMenu() {
            document.getElementById('leaderboard-ui').style.display = 'none';
            document.getElementById('submit-score-ui').style.display = 'none';
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        }

        // Input Handling (Keyboard + Touch)
        document.addEventListener('keydown', (e) => {
            if(e.key === 'ArrowRight') rightPressed = true;
            if(e.key === 'ArrowLeft') leftPressed = true;
            if(e.key === ' ') spacePressed = true;
        });
        document.addEventListener('keyup', (e) => {
            if(e.key === 'ArrowRight') rightPressed = false;
            if(e.key === 'ArrowLeft') leftPressed = false;
            if(e.key === ' ') spacePressed = false;
        });

        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');
        const btnFire = document.getElementById('btn-fire');

        btnLeft.addEventListener('touchstart', (e) => { e.preventDefault(); leftPressed = true; });
        btnLeft.addEventListener('touchend', (e) => { e.preventDefault(); leftPressed = false; });
        
        btnRight.addEventListener('touchstart', (e) => { e.preventDefault(); rightPressed = true; });
        btnRight.addEventListener('touchend', (e) => { e.preventDefault(); rightPressed = false; });

        btnFire.addEventListener('touchstart', (e) => { e.preventDefault(); spacePressed = true; });
        btnFire.addEventListener('touchend', (e) => { e.preventDefault(); spacePressed = false; });

        function initPlayer() {
            player = { 
                x: 275, y: 360, width: 30, height: 20, speed: 5,
                weaponLevel: 1, shield: false, pierce: false, color: '#00ff41'
            };
        }

        function spawnAliens() {
            aliens = [];
            let rows = 3 + Math.floor(wave / 2);
            if (rows > 6) rows = 6;
            for(let r=0; r<rows; r++) {
                for(let c=0; c<8; c++) {
                    let type = TYPES.GRUNT;
                    if (wave > 1 && r === 0) type = TYPES.TANK;
                    if (wave > 2 && r === 1) type = TYPES.SPEED;
                    aliens.push({ 
                        x: 50 + c*60, y: 30 + r*40, width: 30, height: 20, 
                        alive: true, dir: 1, type: type, hp: type.hp, maxHp: type.hp
                    });
                }
            }
        }

        function spawnPowerup(x, y) {
            const r = Math.random();
            let type = 'RAPID';
            let color = '#ffff00';
            if (r > 0.6) { type = 'SHIELD'; color = '#0000ff'; }
            if (r > 0.85) { type = 'PIERCE'; color = '#ff0000'; } // New Lazer
            
            powerups.push({ x, y, width: 15, height: 15, type, color, speed: 2 });
        }

        function createExplosion(x, y, color) {
            for(let i=0; i<8; i++) {
                particles.push({ x, y, vx: (Math.random()-0.5)*4, vy: (Math.random()-0.5)*4, life: 20, color });
            }
        }

        function startGame() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            document.getElementById('game-ui').style.display = 'block';
            score = 0; wave = 1; isGameOver = false;
            initPlayer();
            bullets = []; powerups = []; particles = [];
            spawnAliens();
            if(gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(update, 20);
        }

        function update() {
            if(isGameOver) {
                clearInterval(gameInterval);
                document.getElementById('game-container').style.display = 'none';
                document.getElementById('submit-score-ui').style.display = 'flex';
                document.getElementById('final-score').innerText = score;
                return;
            }

            // Clear & Resize Logic for Mobile
            // (Simple responsive scaling for canvas if needed, but fixed width works for now)
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Player Move
            if(rightPressed && player.x < canvas.width - player.width) player.x += player.speed;
            if(leftPressed && player.x > 0) player.x -= player.speed;

            // Fire
            const fireRate = player.weaponLevel > 1 ? 150 : 400; 
            const now = Date.now();
            if(spacePressed && now - lastShotTime > fireRate) {
                if (player.weaponLevel > 1) {
                    bullets.push({ x: player.x, y: player.y, width: 4, height: 10, speed: 7, pierce: player.pierce });
                    bullets.push({ x: player.x + 26, y: player.y, width: 4, height: 10, speed: 7, pierce: player.pierce });
                } else {
                    bullets.push({ x: player.x + 13, y: player.y, width: 4, height: 10, speed: 7, pierce: player.pierce });
                }
                lastShotTime = now;
            }

            // Draw Player
            ctx.fillStyle = player.shield ? '#00ffff' : player.pierce ? '#ff0000' : player.color;
            ctx.fillRect(player.x, player.y, player.width, player.height);
            if(player.shield) {
                ctx.strokeStyle = '#0000ff'; ctx.lineWidth = 2;
                ctx.strokeRect(player.x-2, player.y-2, player.width+4, player.height+4);
            }

            // Bullets
            ctx.fillStyle = player.pierce ? '#ff0000' : '#fff';
            bullets.forEach((b, i) => {
                b.y -= b.speed;
                ctx.fillRect(b.x, b.y, b.width, b.height);
                if(b.y < 0) bullets.splice(i, 1);
            });

            // Aliens
            let shiftDown = false;
            let activeAliens = 0;
            let waveSpeed = 1 + (wave * 0.2); 

            aliens.forEach(a => {
                if(!a.alive) return;
                activeAliens++;
                ctx.fillStyle = a.type.color;
                ctx.fillRect(a.x, a.y, a.width, a.height);
                // HP Bar
                if (a.type === TYPES.TANK && a.hp < a.maxHp) {
                    ctx.fillStyle = '#fff';
                    ctx.fillRect(a.x, a.y - 5, (a.width * (a.hp/a.maxHp)), 2);
                }
                // Eyes
                ctx.fillStyle = '#000';
                ctx.fillRect(a.x+5, a.y+5, 5, 5); ctx.fillRect(a.x+20, a.y+5, 5, 5);

                a.x += (2 * waveSpeed) * a.dir;
                if(a.x > canvas.width - 40 || a.x < 10) shiftDown = true;

                // Hit Detection
                bullets.forEach((b, bi) => {
                    if(b.x > a.x && b.x < a.x + a.width && b.y > a.y && b.y < a.y + a.height) {
                        if (!b.pierce) bullets.splice(bi, 1);
                        a.hp--;
                        if (a.hp <= 0) {
                            a.alive = false;
                            score += a.type.score;
                            createExplosion(a.x+15, a.y+10, a.type.color);
                            if (Math.random() < 0.15) spawnPowerup(a.x, a.y);
                        }
                    }
                });

                // Game Over Check
                if(a.y > 340) {
                    if (a.x < player.x + player.width && a.x + a.width > player.x) {
                        if (player.shield) { player.shield = false; a.alive = false; createExplosion(a.x, a.y, '#fff'); }
                        else isGameOver = true;
                    } else if (a.y > 380) isGameOver = true;
                }
            });

            if(shiftDown) {
                aliens.forEach(a => { a.dir *= -1; a.y += 20; });
            }

            // Powerups
            powerups.forEach((p, i) => {
                p.y += p.speed;
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x+7, p.y+7, 7, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.font = '10px Arial';
                let letter = 'R';
                if(p.type === 'SHIELD') letter = 'S';
                if(p.type === 'PIERCE') letter = 'L';
                ctx.fillText(letter, p.x+4, p.y+11);

                if (p.x < player.x + player.width && p.x + p.width > player.x &&
                    p.y < player.y + player.height && p.y + p.height > player.y) {
                    if (p.type === 'RAPID') { player.weaponLevel = 2; setTimeout(()=>player.weaponLevel=1, 5000); }
                    else if (p.type === 'SHIELD') { player.shield = true; }
                    else if (p.type === 'PIERCE') { player.pierce = true; setTimeout(()=>player.pierce=false, 5000); }
                    score += 50;
                    powerups.splice(i, 1);
                }
                if (p.y > canvas.height) powerups.splice(i, 1);
            });

            // Particles
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life--;
                ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 2, 2);
                if (p.life <= 0) particles.splice(i, 1);
            });

            // HUD
            document.getElementById('score').innerText = score;
            document.getElementById('wave').innerText = wave;

            if(activeAliens === 0) { wave++; spawnAliens(); }
        }
    </script>
</body>
</html>
